---
title: "Credit Risk project - binary classification models comparison"
author: "Mateusz Majak, Huseyin Can Minareci, Damian Å»amojda"
date: "11 06 2021"
output: 
  html_document:
    number_sections: true
    fig_caption: true
    toc: true
    fig_width: 7
    fig_height: 4.5
    theme: cosmo
    highlight: tango
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
As a final project, using the knowledge gained from the classes, we will compare several binary classification models using dataset consisting binary target variable.

Purpose of the models will be to predict next-day rain by training classification models on the target variable RainTomorrow.


# About the dataset
The dataset used in this project contains about 10 years of daily weather observations from many locations across Australia. It was shared by Joe Young on the Kaggle 
platform and is available [here](https://www.kaggle.com/jsphyg/weather-dataset-rattle-package).

# Preparations {.tabset .tabset-fade .tabset-pills}

## Load libraries
We load multiple libraries for data manipulation and visualisation together with 
tools for data modelling.

```{r message = FALSE}
# data manipulation
library(dplyr)
library(tidyr)
library(mice)
#visualizations
library(ggplot2)
library(ggthemes)
library(scales)
library(extrafont)
library(viridis)
loadfonts()
library(gridExtra)
library(grid)
#modeling
library(caret)
library(corrplot)
```

## Load Data
We load the whole data from csv files.
```{r message = FALSE}
rain_data <- read.csv("weatherAUS.csv")
```

## Data manipulation
We change column data types and deal with NAs when needed.

```{r, fig.height = 6}
#Data types convertion
rain_data$Date <- as.Date(rain_data$Date)
rain_data$Location <- as.factor(rain_data$Location)
rain_data$RainToday <- as.factor(rain_data$RainToday)
rain_data$RainTomorrow <- as.factor(rain_data$RainTomorrow)
rain_data$WindGustDir <- as.factor(rain_data$WindGustDir)
rain_data$WindDir9am <- as.factor(rain_data$WindDir9am)
rain_data$WindDir3pm <- as.factor(rain_data$WindDir3pm)
#NA values
colSums(is.na(rain_data)) %>% 
  sort()

table(rain_data$RainToday, useNA = "ifany")
table(rain_data$RainTomorrow, useNA = "ifany")

#There are many NA values, thus we deal with it in the next steps

```

# Data preview {.tabset .tabset-fade .tabset-pills}
The dataset contains **`r format(dim(rain_data)[1], nsmall=1, big.mark=" ") `** rows and **`r dim(rain_data)[2]`** columns.

This is how it looks like:

```{r}
glimpse(rain_data)

head(rain_data)
```

# Missing values


```{r}
library(naniar)

rain_data %>% 
gg_miss_span(RainTomorrow, 
             span_every = 30000, 
             facet = Location)
```

There are 2 cities containing significant number of missing values in dependent variable: Melbourne and Williamtown.
We consider removing all rows with the data from these cities or just rows with NA values.
For now we will keep all the data, but we save information about rows with the null dependent variable.

``` {r}

NA_cities <- which(is.na(rain_data$RainTomorrow))
rain_data[NA_cities[1:10],]


```

Additionally, we check other variables for missing values.

``` {r}
gg_miss_fct(x = rain_data, fct = Location) + labs(title = "NA values in per each variable and city")

```

It seems there are a lot of NA values in Sunshine, Evaporation, Cloud9am and Cloud3pm columns.

# Data division

```{r}
set.seed(987654321)

rain_which_train <- createDataPartition(rain_data$RainTomorrow,
                                          p = 0.7, 
                                          list = FALSE) 

rain_train <- rain_data[rain_which_train,]
rain_test <- rain_data[-rain_which_train,]

prop.table(table(rain_data$RainTomorrow))
prop.table(table(rain_train$RainTomorrow))
prop.table(table(rain_test$RainTomorrow))

```

Proportion of target variable didn't significantly change after splitting the dataset.

# EDA

## Variables division by type

We group variables by type and save them into list to analyze them later.

```{r, warning=FALSE}
# some plots here (histogram, relationships with the independent variables?)
rain_numeric_vars <- 
  sapply(rain_train, is.numeric) %>% 
  which() %>% 
  names()

rain_factor_vars <- 
  sapply(rain_train, is.factor) %>% 
  which() %>% 
  names()

rain_factor_vars <- rain_factor_vars[1:5]

rain_numeric_vars
rain_factor_vars

```

## Correlation

```{r}
rain_correlations <- 
  cor(rain_train[,rain_numeric_vars],
      use = "pairwise.complete.obs")

rain_numeric_vars_order <- 
  rain_train[,"RainTomorrow"] %>% 
  sort(decreasing = TRUE) %>%
  names()

corrplot.mixed(rain_correlations,
               upper = "circle",
               lower = "pie",
               tl.col="black",
               tl.pos = "lt",
               tl.cex = 0.6)
```

We can see that there are a few groups of variables highly correlated with each other.
Temp3am, Temp9am, MinTemp and MaxTemp are positively correlated which is quite intuitive.
Pressure3pm is positively correlated with Pressure9am which is also intuitive.
Finally, Cloud9am and Cloud3pm are negatively correlated with Sunshine, which is intuitive as well.

## Dependent variable

```{r}
ggplot(rain_train) + geom_bar(aes(x = RainTomorrow))
```

Variable is unbalanced, we will consider dealing with it later.

## Independent Variables

### Numeric variables

```{r, warning=FALSE, message=FALSE, fig.height=25, fig.width=10}
p1 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=MinTemp, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p2 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=MaxTemp, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p3 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Rainfall, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p4 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Evaporation, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p5 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Sunshine, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p6 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=WindGustSpeed, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p7 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=WindSpeed9am, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p8 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=WindSpeed3pm, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p9 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Humidity9am, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p10 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Humidity3pm, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p11 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Pressure9am, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p12 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Pressure3pm, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p13 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Cloud9am, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p14 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Cloud3pm, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p15 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Temp9am, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

p16 <- 
  rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(x=RainTomorrow, y=Temp3pm, fill= RainTomorrow)) + geom_violin() + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()



grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, 
             p9, p10, p11, p12, p13, p14, p15, p16, 
             nrow = 8, ncol = 2)
```
We can visually recognize differences between distributions of Sunshine, Cloud9am,
Cloud3pm and humidity variables with the target variable on the x axis.

### Factor variables

```{r warning=FALSE, message=FALSE, fig.width=10, fig.height=20}
fp1 <- rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(fill = RainTomorrow)) + 
  geom_bar(aes(y = Location)) +
  scale_x_discrete(expand = c(0, 0)) + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

fp2 <- rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(fill = RainTomorrow)) + 
  geom_bar(aes(y = WindGustDir)) +
  scale_x_discrete(expand = c(0, 0)) + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

fp3 <- rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(fill = RainTomorrow)) + 
  geom_bar(aes(y = WindDir9am)) +
  scale_x_discrete(expand = c(0, 0)) + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

fp4 <- rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(fill = RainTomorrow)) + 
  geom_bar(aes(y = WindDir3pm)) +
  scale_x_discrete(expand = c(0, 0)) + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

fp5 <- rain_train %>% 
  dplyr::filter(!is.na(RainTomorrow)) %>% 
  ggplot(aes(fill = RainTomorrow)) + 
  geom_bar(aes(y = RainToday)) +
  scale_x_discrete(expand = c(0, 0)) + scale_fill_viridis(discrete=TRUE, option="viridis") + scale_color_viridis(option="viridis") +  theme_bw()

grid.arrange(fp1, fp2, fp3, fp4, fp5, 
             nrow = 3, ncol = 2)

```


# Modeling

```{r, fig.width=10}

```

# Models comparison

```{r, fig.width=10}

```


# Summary
To sum up.....


